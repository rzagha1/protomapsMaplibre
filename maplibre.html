<html>
    <head>
    <title>7 Million Points</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.css' type='text/css' />
        
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/maplibre-gl-measures@latest/dist/maplibre-gl-measures.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.0/mapbox-gl-draw.js'></script>
    <script src="https://unpkg.com/pmtiles@2.10.0-beta.0/dist/index.js"></script>
    <script src="https://unpkg.com/protomaps-themes-base@1.3.1/dist/index.js"></script>

    <style>
        body {
            margin: 0;
        }
        #map {
            height:100%; width:100%;
        }
        .toggle-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
        }
        </style>
    </head>
    <body>
    <div id="map"></div>
    <button id="toggleBtn" class="toggle-btn">Toggle USPTS</button>
    
    <script>
    let boundingBoxSource;
    let protocol = new pmtiles.Protocol();
    maplibregl.setRTLTextPlugin('https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.js');
    maplibregl.addProtocol("pmtiles", protocol.tile);

    let PMTILES_URL = "https://rzagha1.github.io/flask-map-vts/uspts.pmtiles";
    const mapboxApiKey = "pk.eyJ1IjoicnphZ2hhMSIsImEiOiJjaXVwcDAwZHkwMjBpMnRwNHpmMWIzcTc3In0.iZVkJccpQ8WZp3YnvAKbIg"

    const apiKey = "AAPKb201ea05136f4ff5ab0f9897beef6b1fgVc9q-anpZ_ccGLXop2ftUMVciX06tWquPwUEMGrBqtJW6QIyzRZDXC2dgXgZDNy";
    const basemapEnum = "ArcGIS:LightGray";
    const map = new maplibregl.Map({
        container: "map", // the id of the div element
        style: `https://basemaps-api.arcgis.com/arcgis/rest/services/styles/${basemapEnum}?type=style&token=${apiKey}`,
        zoom: 4, // starting zoom
        center: [-90,40.3], // starting location [longitude, latitude]
        attributionControl: false,
        hash: true
    });
    const baseUrl = "https://basemaps-api.arcgis.com/arcgis/rest/services/styles";
    const url = (name) => `${baseUrl}/${name}?type=style&token=${apiKey}`;

    const setBasemap = (name) => {
        map.setStyle(url(name));
    };
    setBasemap("ArcGIS:LightGray");
    
    let geocoder = new MapboxGeocoder({
        accessToken: mapboxApiKey,
        placeholder: 'Enter an address',
        countries: 'us',
        collapsed: true
      });
    map.addControl(
        geocoder
    );
    geocoder.on('result', function(ev) {
        coords = ev.result.geometry.coordinates;
        if (geocodeMarker) {
            geocodeMarker.remove();
        }
        geocodeMarker = new maplibregl.Marker({
            color: "#FFFFFF",
            draggable: true
            }).setLngLat(coords)
            .addTo(map);
    });
    map.addControl(new maplibregl.NavigationControl());      

    const layer ={
            LYR: 'public.hexagons',
            ID: 'hexagons',
            REF: 'hex_source',
            COLOR: 'orange',
            GEOM: 'Polygon',
            MIN_ZOOM: 1,
            QUERY: '?step=4'
        } 
  
    map.on('load', () => {
        const tilesUrl = layer.QUERY ? `http://164.90.213.82:7800/${layer.LYR}/{z}/{x}/{y}.pbf${layer.QUERY}` : `http://164.90.213.82:7800/${layer.LYR}/{z}/{x}/{y}.pbf`;
        map.addSource(layer.REF, {
            type: 'vector',
            tiles: [tilesUrl],
            minzoom: layer.MIN_ZOOM,
            maxzoom: 22,
            promoteId: 'id'
        });
        map.addLayer({
            id: layer.ID + 'line',
            source: layer.REF,
            'source-layer': layer.LYR,
            type: 'line',
            paint: {
            'line-color': layer.COLOR,
            'line-width': 1
            }
        });
        map.addLayer({
            id: layer.ID,
            source: layer.REF,
            'source-layer': layer.LYR,
            type: 'fill',
            layout: {
            visibility: 'visible'
            },
            paint: {
            'fill-color': layer.COLOR,
            'fill-opacity': [
                'case',
                ['boolean', ['feature-state', 'hover'], false],
                1,
                0.5
            ]
            }
        });

        map.addSource("counties", {
                type: "vector",
                tiles: [
                "https://vectortileservices5.arcgis.com/x3kecEMtcyrJgEOz/arcgis/rest/services/counties_vt_test/VectorTileServer/tile/{z}/{y}/{x}.pbf"
                ]
        });
            
        map.addLayer({
                id: "counties-fill",
                type: "fill",
                source: "counties",
                "source-layer": "ne_10m_admin_0_countries_usa",
                paint: {
                "fill-color": "hsl(200, 80%, 50%)",
                "fill-opacity": 0.5,
                "fill-outline-color": "white"
                }
        });
        map.addSource('uspts', {
            type: 'vector',
            url: "pmtiles://" + PMTILES_URL
        });
        map.addLayer({
            'id': 'pts',
            'source': 'uspts',
            'source-layer': "uspts", // Replace with the source layer name
            'type': 'circle', // Use 'circle' for point data
            'paint': {
                'circle-radius': [
                        'interpolate',
                        ['exponential',2],
                        ['zoom'],
                        0, .5,
                        2,1,
                        6,1.5,
                        8,3, 
                        12,4,
                        18,6 
                    ],
                    'circle-stroke-width': [
                        'interpolate',
                        ['exponential',2],
                        ['zoom'],
                        12, 0, 
                        14, 2
                    ],
                }
            });         
        });

        const popup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: false,
            maxWidth: "none",
        });
        map.on('click', 'pts', (e) => {            
                const feature = e.features[0];
                popup.setHTML(`<table style="font-size:12px">
                        <tr><td>${feature.properties.prop}</td></tr></table>`);
                popup.setLngLat(e.lngLat);
                popup.addTo(map);
        });        

        map.on('click', 'hexagons', (e) => {
                const feature = e.features[0];
                popup.setHTML(`<table style="font-size:12px">
                        <tr><td>${feature.properties.pts}</td></tr></table>`);
                popup.setLngLat(e.lngLat);
                popup.addTo(map);
        });   

        const toggleButton = document.getElementById('toggleBtn');
        toggleButton.addEventListener('click', toggleUSPTS);

        function toggleUSPTS() {
            const layerId = 'pts';
            const layer = map.getLayer(layerId);

            if (layer) {
                const visibility = map.getLayoutProperty(layerId, 'visibility');
                if (visibility === 'visible') {
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                } else {
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                }
            }
        }

        function updateBoundingBoxPolygon() {
            const bounds = map.getBounds();
            const polygonCoordinates = [
                [bounds.getWest(), bounds.getNorth()],
                [bounds.getEast(), bounds.getNorth()],
                [bounds.getEast(), bounds.getSouth()],
                [bounds.getWest(), bounds.getSouth()],
                [bounds.getWest(), bounds.getNorth()] 
            ];
            const features = map.queryRenderedFeatures(polygonCoordinates, { layers: ['pts'] });
            const numFeatures = features.length;
            map.addSource('bounding-box', {
                type: 'geojson',
                data: {
                type: 'Feature',
                geometry: {
                    type: 'Polygon',
                    coordinates: [polygonCoordinates]
                }
                }
            });
            map.addLayer({
                id: 'bounding-box-layer',
                type: 'fill',
                source: 'bounding-box',
                paint: {
                'fill-color': 'yellow',
                "fill-opacity": 0.2,
                'fill-outline-color': 'rgba(0, 0, 0, 0.5)'
                }
            });
            queryPointsWithinBoundingBox(polygonCoordinates);
        }

        function queryPointsWithinBoundingBox(polygonCoordinates) {
            const polygonGeoJSON = {
                type: 'Polygon',
                coordinates: [polygonCoordinates]
            };
            const features = map.querySourceFeatures('uspts', {
                sourceLayer: 'uspts', // Replace with the correct source layer name
                filter: ['within', polygonGeoJSON]
            });
            const numFeatures = features.length;
            console.log(`Number of points within bounding box: ${numFeatures}`);
            if (numFeatures > 0) {
                // Calculate the center of the bounding box
                const centerLng = (polygonCoordinates[0][0] + polygonCoordinates[2][0]) / 2;
                const centerLat = (polygonCoordinates[0][1] + polygonCoordinates[2][1]) / 2;
                const middleCoordinates = [centerLng, centerLat];                
                popup.setLngLat(middleCoordinates)
                .setHTML(`Number of points within bounding box: ${numFeatures}`)
                .addTo(map);
            }
        }
        map.on('moveend', () => {
            if (map.getLayer('bounding-box-layer')){
                map.removeLayer('bounding-box-layer');
            }
            if (map.getSource('bounding-box')) {
                map.removeSource('bounding-box');
            }
            updateBoundingBoxPolygon();
        });
        </script>
    </body>
</html>
